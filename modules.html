
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moduli - FERRIOLI.EU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature-pad.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
        }

        /* Stili navbar uguali a home.html */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .menu-container {
            position: relative;
            margin-right: 15px;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            color: var(--primary);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 5px;
            min-width: 150px;
            z-index: 100;
            left: 0;
            top: 100%;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            color: var(--primary);
            text-decoration: none;
        }

        .dropdown-menu a:hover {
            background: #f5f5f5;
        }

        .show {
            display: block;
        }

        .navbar-logo {
            height: 30px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .user-menu {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #userEmail {
            font-weight: 500;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .btn-logout {
            background: none;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-logout:hover {
            background: var(--accent);
            color: white;
        }

        /* Main Content */
        .modules-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .module-title {
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
        }

        .module-form {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .signature-container {
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .signature-pad {
            width: 100%;
            height: 200px;
            background: #f9f9f9;
            border: 1px solid #ddd;
        }

        .btn-clear {
            margin-top: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-submit {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

        /* Banner Annunci (come in home.html) */
        .announcement-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--secondary);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 90;
        }

        .announcement-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        .close-announcement {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
    <script>
    // Gestione menu a tendina
    document.getElementById('menuBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('dropdownMenu').classList.toggle('show');
    });

    // Chiudi menu cliccando altrove
    document.addEventListener('click', function() {
        document.getElementById('dropdownMenu').classList.remove('show');
    });

    // Logout funzionante
    document.querySelector('.btn-logout').addEventListener('click', function() {
        firebase.auth().signOut().then(() => {
            window.location.href = 'index.html';
        });
    });

    // Chiudi banner annunci
    document.getElementById('closeAnnouncement').addEventListener('click', function() {
        document.getElementById('announcementBanner').style.display = 'none';
    });
</script>
<body>
    <nav class="navbar">
        <div class="menu-container">
            <button class="menu-btn" id="menuBtn">☰</button>
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="home.html">Homepage</a>
                <a href="modules.html">Moduli</a>
            </div>
        </div>
        
        <img src="assets/img/logo.png" alt="Logo" class="navbar-logo">
        
        <div class="user-menu">
            <span id="userEmail"></span>
            <button class="btn-logout">Logout</button>
        </div>
    </nav>

    <div class="modules-container">
        <h1 class="module-title">Modulo di Registrazione Accessi</h1>
        
        <form id="accessForm" class="module-form">
            <div class="form-group">
                <label class="form-label">ID</label>
                <input type="text" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">Nome e cognome</label>
                <input type="text" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">Varco</label>
                <select class="form-control" required>
                    <option value="">Seleziona...</option>
                    <option value="ingresso-principale">Ingresso Principale</option>
                    <option value="ingresso-secondario">Ingresso Secondario</option>
                    <option value="carico-scarico">Area Carico/Scarico</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Orario inizio</label>
                <input type="time" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">Orario fine</label>
                <input type="time" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">Tipologia</label>
                <select class="form-control" required>
                    <option value="">Seleziona...</option>
                    <option value="consegna">Consegna Merci</option>
                    <option value="visita">Visita</option>
                    <option value="manutenzione">Manutenzione</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Note e accadimenti importanti</label>
                <textarea class="form-control" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Firma</label>
                <div class="signature-container">
                    <canvas id="signaturePad" class="signature-pad"></canvas>
                    <button type="button" id="clearSignature" class="btn-clear">Cancella Firma</button>
                    <input type="hidden" id="signatureData" name="signature">
                </div>
            </div>

            <button type="submit" class="btn-submit">Invia Modulo</button>
        </form>
    </div>

    <!-- Banner Annunci -->
    <div class="announcement-banner" id="announcementBanner">
        <div class="announcement-content">
            <span id="announcementText">Caricamento annunci...</span>
            <button class="close-announcement" id="closeAnnouncement">✕</button>
        </div>
    </div>

    <!-- Script -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    
    <script>
        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDitA_4JDkUTJvX7zrfsLgSCDhhWLgP9Cs",
            authDomain: "ferriolieu.firebaseapp.com",
            projectId: "ferriolieu",
            storageBucket: "ferriolieu.appspot.com",
            messagingSenderId: "373796791074",
            appId: "1:373796791074:web:7ed13883e89fcff932fb7b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Elementi UI
        const userEmailElement = document.getElementById('userEmail');
        const logoutBtn = document.querySelector('.btn-logout');
        const menuBtn = document.getElementById('menuBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const announcementBanner = document.getElementById('announcementBanner');
        const announcementText = document.getElementById('announcementText');
        const closeAnnouncement = document.getElementById('closeAnnouncement');
        const accessForm = document.getElementById('accessForm');
        
        // Inizializzazione Signature Pad
        const canvas = document.getElementById('signaturePad');
        const signaturePad = new SignaturePad(canvas);
        
        document.getElementById('clearSignature').addEventListener('click', () => {
            signaturePad.clear();
        });

        // Menu a tendina
        menuBtn.addEventListener('click', () => {
            dropdownMenu.classList.toggle('show');
        });

        // Chiudi menu cliccando altrove
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.menu-container')) {
                dropdownMenu.classList.remove('show');
            }
        });

        // Chiudi annuncio
        closeAnnouncement.addEventListener('click', () => {
            announcementBanner.style.display = 'none';
        });

        // Gestione Auth
        firebase.auth().onAuthStateChanged(user => {
            if(!user) {
                window.location.href = 'index.html';
            } else {
                userEmailElement.textContent = user.email;
                loadAnnouncement();
            }
        });

        logoutBtn.addEventListener('click', () => {
            firebase.auth().signOut();
        });

        // Carica Annunci
        function loadAnnouncement() {
            db.collection('announcements')
                .orderBy('date', 'desc')
                .limit(1)
                .get()
                .then(querySnapshot => {
                    if(!querySnapshot.empty) {
                        const announcement = querySnapshot.docs[0].data();
                        announcementText.textContent = announcement.text;
                    } else {
                        announcementBanner.style.display = 'none';
                    }
                });
        }

        // Invia Modulo
        accessForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if(signaturePad.isEmpty()) {
                alert('Per favore, apponi la tua firma');
                return;
            }

            const formData = {
                id: accessForm.elements[0].value,
                nome: accessForm.elements[1].value,
                varco: accessForm.elements[2].value,
                orarioInizio: accessForm.elements[3].value,
                orarioFine: accessForm.elements[4].value,
                tipologia: accessForm.elements[5].value,
                note: accessForm.elements[6].value,
                signature: signaturePad.toDataURL(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: firebase.auth().currentUser.email
            };

            db.collection('accessLogs').add(formData)
                .then(() => {
                    alert('Modulo inviato con successo!');
                    accessForm.reset();
                    signaturePad.clear();
                })
                .catch(error => {
                    alert('Errore durante l\'invio: ' + error.message);
               
